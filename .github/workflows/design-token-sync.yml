name: Design Token Sync & Auto-Update

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes applied)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

  # Webhook trigger from Figma (when set up)
  repository_dispatch:
    types: [figma-design-tokens-updated]

  # Scheduled check every 30 minutes during work hours
  schedule:
    - cron: '*/30 9-17 * * 1-5'  # Every 30 minutes, 9 AM to 5 PM, weekdays

env:
  NODE_VERSION: '18'
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  detect-design-changes:
    name: ğŸ¨ Detect Design Token Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.fetch-tokens.outputs.has-changes }}
      changes-count: ${{ steps.fetch-tokens.outputs.changes-count }}
      changes-summary: ${{ steps.fetch-tokens.outputs.changes }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Fetch design tokens from Figma
        id: fetch-tokens
        env:
          FIGMA_TOKEN: ${{ secrets.FIGMA_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸ¨ Fetching latest design tokens from Figma..."
          node scripts/fetch-design-tokens.js
        continue-on-error: false

      - name: ğŸ“Š Upload token changes as artifact
        if: steps.fetch-tokens.outputs.has-changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: design-tokens-${{ github.run_id }}
          path: |
            tokens/design-tokens.json
            tokens/design-tokens.previous.json
          retention-days: 30

  generate-style-updates:
    name: ğŸ¤– Generate Style Updates
    runs-on: ubuntu-latest
    needs: detect-design-changes
    if: needs.detect-design-changes.outputs.has-changes == 'true'
    outputs:
      updates-applied: ${{ steps.generate-updates.outputs.updates-applied }}
      plan-path: ${{ steps.generate-updates.outputs.plan-path }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Download design tokens
        uses: actions/download-artifact@v4
        with:
          name: design-tokens-${{ github.run_id }}
          path: tokens/

      - name: ğŸ¤– Generate AI-powered style updates
        id: generate-updates
        env:
          DRY_RUN: ${{ env.DRY_RUN }}
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸ¤– Generating intelligent style updates..."
          node scripts/generate-style-updates.js

      - name: ğŸ“ Upload update plan
        uses: actions/upload-artifact@v4
        with:
          name: update-plan-${{ github.run_id }}
          path: generated-updates/
          retention-days: 30

      - name: ğŸ“ Commit style changes
        if: steps.generate-updates.outputs.updates-applied == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Design Token Sync Bot"
          git add .
          git diff --staged --quiet || git commit -m "ğŸ¨ Auto-update styles from Figma design tokens

          ğŸ“Š Changes detected: ${{ needs.detect-design-changes.outputs.changes-count }}
          ğŸ¤– Generated by Design2Code automation

          Co-authored-by: Figma Design System <design@figma.com>"

  build-and-test:
    name: ğŸ—ï¸ Build & Test Updates
    runs-on: ubuntu-latest
    needs: [detect-design-changes, generate-style-updates]
    if: needs.detect-design-changes.outputs.has-changes == 'true'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: design-tokens-${{ github.run_id }}
          path: tokens/

      - name: ğŸ“Š Download update plan
        uses: actions/download-artifact@v4
        with:
          name: update-plan-${{ github.run_id }}
          path: generated-updates/

      - name: ğŸ—ï¸ Build Storybook
        run: |
          echo "ğŸ—ï¸ Building Storybook with updated styles..."
          npm run build-storybook
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: ğŸ¯ Run Chromatic visual tests
        uses: chromaui/action@v11
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          buildScriptName: build-storybook
          exitZeroOnChanges: false  # We want to know about visual changes
          exitOnceUploaded: true
        id: chromatic

      - name: ğŸ“Š Comment visual test results
        if: github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const chromaticUrl = '${{ steps.chromatic.outputs.url }}';
            const changesCount = '${{ needs.detect-design-changes.outputs.changes-count }}';

            const comment = `## ğŸ¨ Design Token Sync Results

            ### ğŸ“Š Summary
            - **Design Changes Detected:** ${changesCount}
            - **Chromatic Build:** [View Results](${chromaticUrl})
            - **Status:** ${{ job.status }}

            ### ğŸ” Next Steps
            1. Review visual changes in Chromatic
            2. Approve or request changes
            3. Merge if everything looks good

            > ğŸ¤– Generated by Design2Code automation`;

            // For repository_dispatch events, create an issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¨ Design Token Sync - ${new Date().toISOString().split('T')[0]}`,
              body: comment,
              labels: ['design-tokens', 'automated']
            });

  create-pull-request:
    name: ğŸ“ Create Pull Request
    runs-on: ubuntu-latest
    needs: [detect-design-changes, generate-style-updates, build-and-test]
    if: needs.detect-design-changes.outputs.has-changes == 'true' && needs.generate-style-updates.outputs.updates-applied == 'true' && !contains(github.event_name, 'schedule')

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“Š Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: design-tokens-${{ github.run_id }}
          path: tokens/

      - name: ğŸ“Š Download update plan
        uses: actions/download-artifact@v4
        with:
          name: update-plan-${{ github.run_id }}
          path: generated-updates/

      - name: ğŸŒ¿ Create feature branch
        run: |
          BRANCH_NAME="design-tokens/auto-sync-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: ğŸ“ Apply changes and commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Design Token Sync Bot"

          # Add all changes
          git add .

          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¨ Sync design tokens from Figma

            ğŸ“Š Changes: ${{ needs.detect-design-changes.outputs.changes-count }} design tokens updated
            ğŸ¤– Auto-generated style updates applied
            ğŸ¯ Chromatic build triggered for visual testing

            Generated by Design2Code automation pipeline"

            git push origin "$BRANCH_NAME"
          fi

      - name: ğŸ“ Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const changesCount = '${{ needs.detect-design-changes.outputs.changes-count }}';
            const branchName = process.env.BRANCH_NAME;

            const prBody = `## ğŸ¨ Automated Design Token Sync

            This PR contains automated updates based on design token changes detected in Figma.

            ### ğŸ“Š Summary
            - **Design Changes:** ${changesCount} tokens updated
            - **Files Modified:** CSS variables, component styles
            - **Generated:** ${new Date().toISOString()}

            ### ğŸ” What Changed
            - Design tokens extracted from Figma Variables API
            - CSS custom properties updated automatically
            - Component styles analyzed and updated where needed

            ### âœ… Automated Checks
            - [x] Design tokens fetched from Figma
            - [x] Style updates generated with AI
            - [x] Storybook built successfully
            - [x] Chromatic visual tests triggered

            ### ğŸ¯ Next Steps
            1. Review the visual changes in Chromatic
            2. Test components in Storybook
            3. Approve and merge if everything looks good

            > ğŸ¤– This PR was created automatically by the Design2Code pipeline`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¨ Design Token Sync - ${new Date().toISOString().split('T')[0]}`,
              head: branchName,
              base: 'main',
              body: prBody,
              draft: false
            });

            console.log(`Created PR #${pr.data.number}: ${pr.data.html_url}`);

  notify-completion:
    name: ğŸ“¢ Notify Completion
    runs-on: ubuntu-latest
    needs: [detect-design-changes, generate-style-updates, build-and-test]
    if: always() && needs.detect-design-changes.outputs.has-changes == 'true'

    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "## ğŸ¨ Design2Code Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected:** ${{ needs.detect-design-changes.outputs.changes-count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updates Applied:** ${{ needs.generate-style-updates.outputs.updates-applied }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](${{ github.server_url }}/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ğŸ¤– Automated by Design2Code pipeline"